<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š Panel de Administrador - CreatÃ­metro Digital</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>ğŸ“Š Panel de Administrador</h1>
            <p>CreatÃ­metro Digital - AnÃ¡lisis de Creatividad</p>
        </header>

        <!-- EstadÃ­sticas Generales -->
        <section class="stats-section">
            <h2>ğŸ“ˆ EstadÃ­sticas Generales</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-value" id="totalResponses">-</div>
                    <div class="stat-label">Total Respuestas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ’¡</div>
                    <div class="stat-value" id="avgFluency">-</div>
                    <div class="stat-label">Fluidez Promedio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ”€</div>
                    <div class="stat-value" id="avgFlexibility">-</div>
                    <div class="stat-label">Flexibilidad Promedio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ¯</div>
                    <div class="stat-value" id="avgCreativity">-</div>
                    <div class="stat-label">Creatividad Promedio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ˜Š</div>
                    <div class="stat-value" id="avgFun">-</div>
                    <div class="stat-label">DiversiÃ³n Promedio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">â±ï¸</div>
                    <div class="stat-value" id="avgTime">-</div>
                    <div class="stat-label">Tiempo Promedio</div>
                </div>
            </div>
        </section>

        <!-- Controles de ExportaciÃ³n -->
        <section class="export-section">
            <h2>ğŸ“ Exportar Datos</h2>
            <div class="export-buttons">
                <button id="exportCsv" class="export-btn">
                    ğŸ“Š Exportar CSV
                </button>
                <button id="exportJson" class="export-btn">
                    ğŸ“„ Exportar JSON
                </button>
                <button id="refreshData" class="refresh-btn">
                    ğŸ”„ Actualizar Datos
                </button>
            </div>
        </section>

        <!-- Lista de Respuestas -->
        <section class="responses-section">
            <h2>ğŸ“ Respuestas de Estudiantes</h2>
            <div id="responsesList" class="responses-list">
                <!-- Las respuestas se cargarÃ¡n aquÃ­ dinÃ¡micamente -->
            </div>
        </section>

        <!-- Mensaje de estado -->
        <div id="adminMessage" class="admin-message" style="display: none;"></div>
    </div>

    <script>
        // Variables globales
        let allResponses = [];

        // Elementos del DOM
        const statsGrid = document.getElementById('statsGrid');
        const responsesList = document.getElementById('responsesList');
        const adminMessage = document.getElementById('adminMessage');
        const exportCsvBtn = document.getElementById('exportCsv');
        const exportJsonBtn = document.getElementById('exportJson');
        const refreshDataBtn = document.getElementById('refreshData');

        // FunciÃ³n para cargar estadÃ­sticas
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const result = await response.json();

                if (result.success) {
                    const stats = result.data;
                    
                    document.getElementById('totalResponses').textContent = stats.totalRespuestas;
                    document.getElementById('avgFluency').textContent = stats.promedioFluidez.toFixed(1);
                    document.getElementById('avgFlexibility').textContent = stats.promedioFlexibilidad.toFixed(1);
                    document.getElementById('avgCreativity').textContent = stats.promedioPuntaje.toFixed(1);
                    document.getElementById('avgFun').textContent = stats.promedioDiversion.toFixed(1);
                    document.getElementById('avgTime').textContent = formatTime(stats.promedioTiempo);
                }
            } catch (error) {
                console.error('Error cargando estadÃ­sticas:', error);
                showAdminMessage('âŒ Error cargando estadÃ­sticas', 'error');
            }
        }

        // FunciÃ³n para cargar respuestas
        async function loadResponses() {
            try {
                const response = await fetch('/api/responses');
                const result = await response.json();

                if (result.success) {
                    allResponses = result.data;
                    renderResponses();
                }
            } catch (error) {
                console.error('Error cargando respuestas:', error);
                showAdminMessage('âŒ Error cargando respuestas', 'error');
            }
        }

        // FunciÃ³n para renderizar respuestas
        function renderResponses() {
            if (allResponses.length === 0) {
                responsesList.innerHTML = '<div class="no-responses">ğŸ“­ No hay respuestas aÃºn.</div>';
                return;
            }

            responsesList.innerHTML = allResponses.map(response => {
                const ideasCount = response.ideas.filter(idea => idea && idea.trim().length > 0).length;
                const formattedDate = new Date(response.timestamp).toLocaleString('es-ES');
                
                return `
                    <div class="response-card" data-id="${response.id}">
                        <div class="response-header">
                            <h3>ğŸ‘¤ ${response.nombre}</h3>
                            <div class="response-actions">
                                <button class="delete-btn" onclick="deleteResponse('${response.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        
                        <div class="response-info">
                            <div class="info-item">
                                <strong>ğŸ“§ Correo:</strong> ${response.correo}
                            </div>
                            <div class="info-item">
                                <strong>ğŸ“… Fecha:</strong> ${formattedDate}
                            </div>
                            <div class="info-item">
                                <strong>â±ï¸ Tiempo utilizado:</strong> ${formatTime(response.tiempoUtilizado)}
                            </div>
                        </div>

                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-value">${response.metricas.fluidez}/10</div>
                                <div class="metric-label">ğŸ’¡ Fluidez</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${response.metricas.flexibilidad}</div>
                                <div class="metric-label">ğŸ”€ Flexibilidad</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${response.metricas.puntajeCreatividad}/100</div>
                                <div class="metric-label">ğŸ¯ Creatividad</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${response.diversion}/5</div>
                                <div class="metric-label">ğŸ˜Š DiversiÃ³n</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${response.desafio}/5</div>
                                <div class="metric-label">ğŸ§© DesafÃ­o</div>
                            </div>
                        </div>

                        <div class="ideas-section">
                            <h4>ğŸ’¡ Ideas generadas (${ideasCount}/10):</h4>
                            <div class="ideas-list">
                                ${response.ideas.map((idea, index) => 
                                    idea && idea.trim() ? 
                                    `<div class="idea-item"><strong>${index + 1}.</strong> ${idea}</div>` : 
                                    `<div class="idea-item empty"><strong>${index + 1}.</strong> <em>Sin respuesta</em></div>`
                                ).join('')}
                            </div>
                        </div>

                        <div class="feedback-section">
                            <div class="feedback-item">
                                <strong>ğŸ”„ MÃ¡s actividades:</strong> ${response.masActividades || 'No especificado'}
                            </div>
                            ${response.comentarios ? `
                                <div class="feedback-item">
                                    <strong>âœï¸ Comentarios:</strong> ${response.comentarios}
                                </div>
                            ` : ''}
                        </div>

                        <div class="grading-section">
                            <label for="grade-${response.id}">ğŸ“ CalificaciÃ³n manual (0-100):</label>
                            <div class="grade-input-group">
                                <input 
                                    type="number" 
                                    id="grade-${response.id}" 
                                    min="0" 
                                    max="100" 
                                    value="${response.calificacionManual || ''}"
                                    placeholder="CalificaciÃ³n"
                                >
                                <button onclick="saveGrade('${response.id}')" class="save-grade-btn">
                                    ğŸ’¾ Guardar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // FunciÃ³n para eliminar respuesta
        async function deleteResponse(id) {
            if (!confirm('Â¿EstÃ¡s seguro de que quieres eliminar esta respuesta?')) {
                return;
            }

            try {
                const response = await fetch(`/api/responses/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAdminMessage('âœ… Respuesta eliminada exitosamente', 'success');
                    loadData(); // Recargar datos
                } else {
                    showAdminMessage(`âŒ Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error eliminando respuesta:', error);
                showAdminMessage('âŒ Error de conexiÃ³n', 'error');
            }
        }

        // FunciÃ³n para guardar calificaciÃ³n
        async function saveGrade(id) {
            const gradeInput = document.getElementById(`grade-${id}`);
            const calificacion = parseInt(gradeInput.value);

            if (isNaN(calificacion) || calificacion < 0 || calificacion > 100) {
                showAdminMessage('âŒ La calificaciÃ³n debe estar entre 0 y 100', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/responses/${id}/grade`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ calificacion })
                });

                const result = await response.json();

                if (result.success) {
                    showAdminMessage('âœ… CalificaciÃ³n guardada exitosamente', 'success');
                } else {
                    showAdminMessage(`âŒ Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error guardando calificaciÃ³n:', error);
                showAdminMessage('âŒ Error de conexiÃ³n', 'error');
            }
        }

        // FunciÃ³n para exportar a CSV
        function exportToCSV() {
            if (allResponses.length === 0) {
                showAdminMessage('âŒ No hay datos para exportar', 'error');
                return;
            }

            const headers = [
                'Nombre', 'Correo', 'Fecha', 'Tiempo (seg)', 'Fluidez', 'Flexibilidad', 
                'Creatividad', 'DiversiÃ³n', 'DesafÃ­o', 'MÃ¡s Actividades', 'Comentarios',
                'CalificaciÃ³n Manual', ...Array.from({length: 10}, (_, i) => `Idea ${i + 1}`)
            ];

            const csvData = allResponses.map(response => [
                response.nombre,
                response.correo,
                new Date(response.timestamp).toLocaleString('es-ES'),
                response.tiempoUtilizado,
                response.metricas.fluidez,
                response.metricas.flexibilidad,
                response.metricas.puntajeCreatividad,
                response.diversion,
                response.desafio,
                response.masActividades,
                response.comentarios || '',
                response.calificacionManual || '',
                ...response.ideas
            ]);

            const csvContent = [headers, ...csvData]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');

            downloadFile(csvContent, 'creativimetro-datos.csv', 'text/csv');
            showAdminMessage('âœ… Archivo CSV descargado exitosamente', 'success');
        }

        // FunciÃ³n para exportar a JSON
        function exportToJSON() {
            if (allResponses.length === 0) {
                showAdminMessage('âŒ No hay datos para exportar', 'error');
                return;
            }

            const jsonContent = JSON.stringify(allResponses, null, 2);
            downloadFile(jsonContent, 'creativimetro-datos.json', 'application/json');
            showAdminMessage('âœ… Archivo JSON descargado exitosamente', 'success');
        }

        // FunciÃ³n para descargar archivo
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // FunciÃ³n para formatear tiempo
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // FunciÃ³n para mostrar mensajes de administrador
        function showAdminMessage(message, type) {
            adminMessage.innerHTML = message;
            adminMessage.className = `admin-message ${type}`;
            adminMessage.style.display = 'block';
            
            setTimeout(() => {
                adminMessage.style.display = 'none';
            }, 5000);
        }

        // FunciÃ³n para cargar todos los datos
        async function loadData() {
            await Promise.all([loadStats(), loadResponses()]);
        }

        // Event listeners
        exportCsvBtn.addEventListener('click', exportToCSV);
        exportJsonBtn.addEventListener('click', exportToJSON);
        refreshDataBtn.addEventListener('click', loadData);

        // Cargar datos al inicializar
        loadData();

        // Auto-refresh cada 30 segundos
        setInterval(loadData, 30000);
    </script>
</body>
</html>
